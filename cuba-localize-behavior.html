<script>
  (function() {

    let serverMessagesSource;
    let enumSource;

    function getServerMessageSource() {
      if (!serverMessagesSource) {
        serverMessagesSource = Rx.Observable.fromPromise(cubaApp.loadEntitiesMessages());
      }
      return serverMessagesSource;
    }

    function getEnumSource() {
      if (!enumSource) {
        enumSource = Rx.Observable.fromPromise(_loadEnums());
      }
      return enumSource;
    }

    /**
     * @polymerBehavior CubaLocalizeBehavior
     */
    CubaLocalizeBehavior = {

      properties: {

        useKeyIfMissing: {
          type: Boolean,
          value: true
        },

        enums: {
          type: Object,
          readonly: true,
        },

        messages: {
          type: Object,
          value: {}
        },

        serverMessages: {
          type: Object,
          readonly: true
        },

        msg: {
          type: Function,
          computed: '__computeMsg(serverMessages, messages)'
        },

        enumValues: {
          type: Function,
          computed: '__computeEnumValues(enums)'
        }

      },

      created: function() {
        getServerMessageSource().subscribe((serverMessages) => {
          this.serverMessages = serverMessages;
          this.notifyPath('serverMessages');
        });
        getEnumSource().subscribe((enums) => {
          this.enums = enums;
          this.notifyPath('enums');
        });
      },

      __computeMsg: function(serverMessages, messages) {
        return (key) => {

          let message = messages[cubaApp.locale] ? messages[cubaApp.locale][key] : null;

          if (!message) {
            message = serverMessages[key];
          }

          if (!message) {
            return this.useKeyIfMissing ? key : '';
          }
          return message;
        }
      },

      __computeEnumValues: function(enums) {
        return (enumName) => {
          return enums[enumName];
        }
      }
    };

    function _loadEnums() {
      return new Promise(function(resolve, reject) {
        cubaApp.loadEnums().then(
          (enums) => {
            let convertedEnums = {};
            enums.map((e) => {
              convertedEnums[e.name] = _convertEnumValues(e.values);
            });
            setTimeout(() => {
              resolve(convertedEnums);
            }, 3000);
          },
          () => {
            reject();
          })
      });
    }

    function _convertEnumValues(rawValues) {
      let values = [];
      rawValues.forEach((rawValue) => {
        values.push({
          id: rawValue.id,
          value: rawValue.name,
          label: rawValue.description
        });
      });
      return values;
    }
  })();
</script>